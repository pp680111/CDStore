<?php
    require_once('header.php');
    require_once('CDStore_fns.php');
    $cd_data = get_cd_detail($_REQUEST['cd_id']);
?>

<div class="container-fluid">
    <div class="row">
        <div class="col-xs-10 col-xs-offset-1 content">
            <div class="detail">
                <form method="post" action="" enctype="multipart/form-data" id="myForm">
                    <input type="hidden" name="cd_id" value="<?php echo $_REQUEST['cd_id'];?>"/>
                    <div class="form-group">
                        <label>专辑封面</label>
                        <input type="file" accept="image/png,image/jpeg" id="cd_cover" name="cover">
                        <img src="static/img/cover/<?php echo $cd_data['id'];?>.jpg" width="200px" height="200px" id="cd_cover_preview" alt="">
                    </div>
                    <div class="form-group">
                        <label>专辑名称</label>
                        <input type="text" name="name" class="form-control" required value="<?php echo $cd_data['name'] ?>">
                    </div>
                    <div class="form-group">
                        <label>艺术家</label>
                        <input type="text" name="artist" class="form-control" required value="<?php echo $cd_data['artist'] ?>">
                    </div>
                    <div class="form-group">
                        <label>库存数</label>
                        <input type="text" name="amount" class="form-control" required value="<?php echo $cd_data['amount'] ?>">
                    </div>
                    <div class="form-group">
                        <label>CD介绍</label>
                        <input type="text" name="presentation" class="form-control" value="<?php echo $cd_data['presentation'] ?>">
                    </div>
                    <div class="form-group">
                        <label>曲目列表</label>
                        <div class="song_list_controller">
                            <span class="glyphicon glyphicon-plus" id="plus"></span>
                            <span class="glyphicon glyphicon-minus" id="minus"></span>
                        </div>
                        <table class="table" id="song_list">
                            <thead>
                                <th>曲目顺序</th>
                                <th>曲名</th>
                                <th>艺术家</th>
                            </thead>
                            <tbody>
                                <?php
                                    for($i = 0;$i < count($cd_data['song_list']);$i++)
                                    {
                                        echo "<tr>";
                                        echo "<td>$i</td>";
                                        echo "<td><input type='text' name='song_name[]' class='form-control' required value='{$cd_data['song_list'][$i]['name']}'></td>";
                                        echo "<td><input type='text' name='song_artist[]' class='form-control' required value='{$cd_data['song_list'][$i]['artist']}'></td>";
                                        echo "</tr>";
                                    };
                                ?>
                            </tbody>
                        </table>
                    </div>

                    <button type="button" class="btn btn-default" id="submit_data">提交</button>
                </form>  
            </div>
        </div>
    </div>
</div>
<!-- modal -->
<div class="modal fade" role="dialog" id="message">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="message_content"></h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="confirm_message">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- modal end -->

<script src="../static/js/jquery-3.1.1.min.js"></script>
<script src="../static/js/bootstrap.min.js"></script>
<script>
    $("#plus").click(function(){
        var newRow = '<tr><td>' + (parseInt($("#song_list > tbody > tr:last > td:first").text()) + 1) + '</td>';
        newRow += '<td><input type="text" name="song_name[]" class="form-control" required></td>';
        newRow += '<td><input type="text" name="song_artist[]" class="form-control" required></td></tr>';
        $("#song_list > tbody > tr:last").after(newRow);
    });

    $("#minus").click(function(){
        if($("#song_list > tbody > tr").length <= 1)
            alert('曲目数量不得少于1');
        else $("#song_list > tbody > tr:last").remove();
    });

    $("#cd_cover").change(function(){
        var img_file = $(this)[0].files[0];
        if(window.FileReader)
        {
            var reader = new FileReader();
        }
        else{
            $("#cd_cover_preview").attr('alt','当前浏览器不支持图片预览，请使用支持HTML5的浏览器');
        }

        var imageType = /^image\//;
        if(!imageType.test(img_file.type))
        {
            alert('请选择图片');
        }

        reader.onload = function(e){
            $("#cd_cover_preview").attr('src',e.target.result);
        }
        reader.readAsDataURL(img_file);
    });

    $("#submit_data").click(function(){
        var formdata = new FormData(document.getElementById('myForm'));
        $.ajax({
            url:'modify_cd.php',
            type:'post',
            dataType:'json',
            data:formdata,
            processData: false,
            contentType: false,
            success:function(data){
                if(data.status == 'success')
                {
                    $("#message").modal('show');
                    $("#message_content").text(data.message);
                    $('#confirm_message').click(function(){window.location.href='admin.php';});
                }
                else{
                    $("#message").modal('show');
                    $("#message_content").text(data.message);
                }
            },
            error:function(){
                $("#message").modal('show');
                $("#message_content").text('发送数据到服务器时发生错误');
            }
        });
    })
</script>
<?php require_once('footer.php');?>